services:
  controller:
    build:
      context: ../../../
      dockerfile: test/docker/slurm/Dockerfile
    command: controller
    image: slurm
    hostname: controller
    volumes:
      - jobs_dir:/jobs
      - ../../../:/host-source
    expose:
      - 6817
    ports:
      - 9090:9090

  node:
    build:
      context: ../../../
      dockerfile: test/docker/slurm/Dockerfile
    command: node
    image: slurm
    hostname: node
    volumes:
      - jobs_dir:/jobs
      - ../../../:/host-source
    expose:
      - 6818
      - 8000
    devices:
      - /dev/kfd
      - /dev/dri
    security_opt:
      - seccomp=unconfined
    depends_on:
      - controller
    links:
      - controller
    healthcheck:
      test: curl --fail localhost:8000/metrics || exit 1
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 15s

volumes:
  jobs_dir:
